<% @title = 'прямой эфир как он есть' %>
<% content_for :head do %>
  <%#= auto_discovery_link_tag(:rss, service_url(main_feed_path(:action => :live))) %>
<% end %>
<div class='onair'>
  <div class='entry_pg'>
	  <%= paginate @entries, { :css_class => 'top_nav_paginator', :url_options => { :tag => params[:tag] } } if @page && @page > 1 %>
	</div>

	<% @entries.each do |entry| %>
		<%= render :partial => 'entries/entry_display', :locals => { :entry => entry, :show_comments_bubble => true, :show_username => true, :show_tags => false, :comment_views => @comment_views } %>
	<% end %>

  <div class='entry_pg'>
  	<%= paginate @entries, { :url_options => { :tag => params[:tag] } } if @page %>
  	<%= link_to 'infinitenext', { :action => :live, :page => nil, :entry_id => @entries.last.id }, :class => 'infinitenext', :style => 'display: none' %>
  </div>
</div>

<% if (!@page || @page <= 1) && !params[:tag] %>
<script type='text/javascript'>
  var inf_entry_id = <%= @entries.last.id.to_json %>;
  var inf_page = 1;
  var inf_opts = {
    navSelector: 'div.entry_pg',
    nextSelector: 'div.entry_pg a.infinitenext',
    itemSelector: 'div.post_body',
    pathParse: function(path, page) { var p = path.split('=')[0] + '=' + inf_entry_id; return p; },
    debug: false,
    loadingImg: 'http://assets0.mmm-tasty.ru/images/blank.gif',
    loadingText: '<em>Загружаем ...</em>',
    donetext: '<em>На этом все, спасибо.</em>'    
  }
  
  function inf_loaded_handler(items) {
    inf_page += 1;

    // report to analytics
    ga_event('Infinite Scroll', 'Live', current_user ? _user.url : 'anonymous', inf_page);
    
    // fix fancybox changing document height issue
    // jQuery('#fancybox-overlay').
    //   clone().
    //   append('#fancybox-overlay').
    //   prev().
    //   remove();

    // reinitialize fancybox & update last entry id
    items.each(function(obj, i) {
      var jqo = jQuery(obj);

      inf_entry_id = jqo.attr('id').split('_').last();

      if (current_user) { enable_services_for_current_user(); };

      jqo.
        find('a.fancybox').
        removeClass('fancybox').
        fancybox({
            centerOnScroll: true,
            hideOnContentClick: true,
            showNavArrows: false,
            enableKeyboardNav: false
          });
    });
  }

  jQuery('.onair').infinitescroll(inf_opts, inf_loaded_handler);
  // unbind normal behavior. needs to occur after normal infinite scroll setup.
  // jQuery(window).unbind('.infscr');
  // 
  // msg = jQuery('<div id="infscr-loading" style="text-align: center;"><div id="infscr-click">&darr; Загрузить &darr;</div></div>');
  // msg.appendTo(jQuery('div.entry_pg')).show().click(function() {
  //     jQuery(document).trigger('retrieve.infscr');
  //     return false;
  //   });
  // jQuery('div.entry_pagination').hide();
</script>
<% end %>

<% content_for :sidebar_right do %>
	<div class='section'>
		<h2><span>Немного навигации</span></h2>
		<div class='vertical_nav'>
			<%= link_to 'общий прямой эфир', { :action => :live, :page => nil }, :class => (params[:action] == 'live' && !params[:tag]) ? 'highlight' : nil %><br/>
			<%= link_to 'моё', :action => :my %>
			<%#= link_to('персональная лента', { :action => :my, :page => nil }, :class => (params[:action] == 'last_personalized') ? 'highlight' : nil) %>
		</div>
	</div>
<% end if false && current_user %>