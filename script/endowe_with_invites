#!/usr/bin/env script/runner

blacklisted = $redis.smembers 'comments:blacklist'

User.active.paginated_each(:per_page => 1000) do |user|
  if user.ban_ac_till.nil? &&
     !user.is_disabled? &&
     user.is_confirmed? &&
     user.entries_count >= 2 &&
     user.is_mainpageable? && 
     user.created_at < 1.months.ago &&
     blacklisted.exclude?(user.id) &&
     user.invitations_left < 3 &&
     user.listed_me_as_all_friend_light.length >= 3
     
     # skip this user if any of his already invited friends is guilty...
     next user.invitations.accepted.map(&:invitee).select do |invitee|
       invitee.is_disabled? || !invitee.is_mainpageable? || blacklisted.include?(invitee.id) || invitee.ban_ac_till
     end.length > 0

    user.increment!(:invitations_left)
    puts "+ #{user.url} shall be endowed"
  end
end
